name: Contract Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  check-format:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        targets: wasm32-unknown-unknown
        components: rustfmt, clippy

    - name: Install Soroban CLI
      run: |
        cargo install --locked soroban-cli
        rustup target add wasm32-unknown-unknown

    - name: Check formatting
      run: |
        cd contracts
        cargo fmt --check

  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        targets: wasm32-unknown-unknown
        components: rustfmt, clippy

    - name: Install Soroban CLI
      run: |
        cargo install --locked soroban-cli
        rustup target add wasm32-unknown-unknown

    - name: Run clippy
      run: |
        cd contracts
        cargo clippy --all-targets --all-features -- -D warnings

  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        targets: wasm32-unknown-unknown

    - name: Install Soroban CLI
      run: |
        cargo install --locked soroban-cli
        rustup target add wasm32-unknown-unknown

    - name: Run tests
      run: |
        cd contracts
        cargo test --workspace

  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        targets: wasm32-unknown-unknown

    - name: Install Soroban CLI
      run: |
        cargo install --locked soroban-cli
        rustup target add wasm32-unknown-unknown

    - name: Build contracts
      run: |
        cd contracts
        cargo build --target wasm32-unknown-unknown --release
        # Verify WASM files were created
        find . -name "*.wasm" -type f

  contract-verification:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        targets: wasm32-unknown-unknown

    - name: Install Soroban CLI
      run: |
        cargo install --locked soroban-cli
        rustup target add wasm32-unknown-unknown

    - name: Verify contract structure
      run: |
        cd contracts
        # Check that each contract has required files
        for contract_dir in */; do
          if [ -d "$contract_dir" ]; then
            contract_name=$(basename "$contract_dir")
            echo "Checking contract: $contract_name"
            
            # Verify Cargo.toml exists
            if [ ! -f "$contract_dir/Cargo.toml" ]; then
              echo "Error: $contract_dir/Cargo.toml not found"
              exit 1
            fi
            
            # Verify src/lib.rs exists
            if [ ! -f "$contract_dir/src/lib.rs" ]; then
              echo "Error: $contract_dir/src/lib.rs not found"
              exit 1
            fi
            
            echo "âœ“ Contract $contract_name structure verified"
          fi
        done

  audit:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        targets: wasm32-unknown-unknown

    - name: Install Soroban CLI
      run: |
        cargo install --locked soroban-cli
        rustup target add wasm32-unknown-unknown

    - name: Install cargo-audit
      run: cargo install cargo-audit

    - name: Audit dependencies
      run: |
        cd contracts
        cargo audit